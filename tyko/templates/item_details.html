{% from "_macros.html" import notes_table_head, notes_table_row, notes_new_button_row %}
{% extends "details_table.html" %}
{% block entity_navbar %}
<nav class="navbar navbar-expand-lg  navbar-light justify-content-start bg-light">
    <div class="mx-1">
        <button class="btn btn-outline-primary "
                type="button"
                disabled
                >New</button>
    </div>
</nav>
{% endblock %}
{% block detail_table %}
<div class="card my-1">
    <div class="card-body">
        <table class="table">
            <tbody>
                {%- for field in fields -%}
                    <tr>
                        <td style="width: 16.66%" class="font-weight-bold">{{field.name}}</td>
                        <td>
                            <div id="{{field.name}}Label">

                                {% if field.key_branch is not none and field.key_branch in item %}
                                    {{ item[field.key_branch][field.key]}}
                                {% else %}
                                    {{- item[field.key] -}}
                                {% endif %}
                            </div>
                            <div id="{{field.key}}InputGroup" class="input-group" hidden>
                                {% if field.editable %}
                                    <input id="{{field.key}}Input" type="text" class="form-control" value="{{-item.get(field.key) or ""-}}">
                                    <div class="input-group-append">
                                    <button id="{{field.key}}Confirm"
                                            onclick="confirmUpdate('{{ api_path }}', '{{field.key}}')"
                                            class="btn btn-outline-secondary">Confirm</button>
                                {% endif %}
                              </div>
                            </div>
                        </td>
                        <td style="width: 5%">
                            {% if field.editable %}
                            <button id="editButton{{loop.index}}" class="btn btn-secondary float-right btn-sm">Edit</button>
                            <script>
                                document.getElementById("editButton{{loop.index}}").onclick = function (){
                                    flipMode(
                                        "{{field.name}}Label",
                                        "{{field.key}}InputGroup",
                                        "{{field.key}}Input",
                                        "{{-item.get(field.key) or ""-}}",
                                        "editButton{{loop.index}}"

                                    )
                                };
                                document.getElementById("{{field.key}}Input").addEventListener('keypress', (e) => {
                                    if (e.key === "Enter") {
                                        document.getElementById("{{field.key}}Confirm").click();
                                    }
                                });
                            </script>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="card">
    <h5 class="card-header">Notes</h5>
    <div class="card-body">
        <table class="table">
            {{ notes_table_head(item['notes']) }}
            <tbody>
                {%- for note in item['notes'] -%}
                    {{ notes_table_row(note, "/api/project/" ~ project_id ~ "/object/" ~ object_id ~ "/item/" ~ item.item_id ~ "/notes/" ~ note['note_id']) }}
                {%- endfor -%}
                {{ notes_new_button_row(api_path) }}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ note_editor_events("/api/project/" ~ project_id ~ "/object/" ~ object_id ~ "/item/" ~ item.item_id, valid_note_types) }}
{% endblock %}