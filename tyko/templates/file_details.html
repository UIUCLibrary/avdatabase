{% extends "panel_details.html" %}
{% from "_macros.html" import notes_table_row, notes_table, metadata_table %}
{% import  "_details_macros.html" as widgets%}
{% import  "dialog_boxes.html" as dialog %}

{% block main_details %}
    {%  call widgets.card("Details", "my-1 h-100")  %}
        {%  call metadata_table() %}
            <tr>
                {{widgets.metadata_text_edit_widget("File Name", file['file_name'], 'file_name', api_path)}}
            </tr>
            <tr>
                {{ widgets.metadata_select_edit_widget("Generation",
                                                       file['generation'],
                                                       options=[
                                                        {
                                                            "value": "Access",
                                                            "text": "Access"
                                                        },
                                                        {
                                                            "value": "Preservation",
                                                            "text": "Preservation"
                                                        },
                                                        ],
                                                       field_key='generation',
                                                       update_api_path=api_path) }}
            </tr>
        {% endcall %}
    {% endcall %}
{% endblock %}

{% block secondary_details %}
    {% call widgets.card("Annotations", "my-1")  %}
        <div class="card-footer bg-transparent">
            <button class="btn btn-primary float-right"
                    onclick="alert('does nothing right now')">
                Add</button>
        </div>
    {% endcall %}
{#        TODO: setup file annotations#}
    {% call widgets.card("Notes", "my-1")  %}
            <ul id="notesList" class="list-group list-group-flush">
            {% for note in file['notes'] %}
                <li class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <div>

                        {{ note['message'] }}
                        </div>
                        <div>

                            <div class="btn-group" role="group" aria-label="Edit">
                                <button type="button"
                                        class="btn btn-sm btn-secondary dropdown-toggle"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"></button>
                                <div class="dropdown-menu">
                                <button class="btn btn-secondary btn-sm dropdown-item"
                                        id="noteEditButton{{ loop.index }}">
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm dropdown-item"
                                        id="noteRemoveButton{{ loop.index }}">
                                    Remove
                                </button>
                                <script type="module">
                                    function encode(d){
                                        let t = document.createElement('div');
                                        t.innerText = t.innerContent = d;
                                        return t.innerHTML;
                                    }
                                    document.getElementById("noteEditButton{{ loop.index }}").addEventListener('click', function () {
                                        document.getElementById("notesList").dispatchEvent(
                                            new CustomEvent("editNote", {
                                                    detail: {
                                                        "note": Notes.noteData(
                                                            {% autoescape false %}
                                                            "{{ note['message'] }}",
                                                            {% endautoescape %}
                                                            {{note['id'] }}),
                                                        "file": Notes.fileData({{ note['file_id'] }}),
                                                        "request": Notes.requestData("edit", "{{ url_for('file_note', file_id=note['file_id'], note_id=note['id'])}}")
                                                    }
                                                })
                                        )
                                    })
                                    document.getElementById("noteRemoveButton{{ loop.index }}").addEventListener('click', function () {
                                        document.getElementById("notesList").dispatchEvent(
                                            new CustomEvent("removeNote", {
                                                    detail: {
                                                        "note": Notes.noteData(
                                                            {% autoescape false %}
                                                            "{{ note['message'] }}",
                                                            {% endautoescape %}
                                                            {{note['id'] }}),
                                                        "file": Notes.fileData({{ note['file_id'] }}),
                                                        "request": Notes.requestData("remove", "{{ url_for('file_note', file_id=note['file_id'], note_id=note['id'])}}")
                                                    }
                                                })
                                        )
                                    })
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            {% endfor %}
            </ul>
        <script type="application/javascript" src="{{ url_for('static', filename='js/notes.js') }}"></script>
        <script type="module">
            import {files} from "{{url_for('static', filename="js/api.js")}}"
            const removeModal = document.getElementById("removeNoteModal");
            removeModal.addEventListener("accept", function (event) {
                    console.log("Got accept to delete");
                    console.log("Got accept to delete note id " + event.detail['note']["id"])
                    console.log("Got accept to delete note from file id  " + event.detail['file']["id"])
                    console.log("Got accept to use request  " + event.detail['request']["url"])
                    {#TODO: delete note#}
                    files.removeNote(
                        event.detail['request']['url']).then(function () {
                            location.reload();
                        }).catch(function (res) {
                            alert("Failed to edit note");
                        })
                    $(removeModal).modal('hide');
            });
            const editModal = document.getElementById("editNoteModal");
            editModal.addEventListener("accept", function (event) {
                    switch (event.detail['request']['type']) {
                        case "edit":
                            files.editNote(
                                event.detail['request']['url'],
                                {
                                    "message": event.detail['note']["text"]
                                }).then(function () {
                                    location.reload();
                                }).catch(function (res) {
                                    alert("Failed to edit note");
                                })
                            break;
                        case "create":
                            files.addNote(
                                event.detail['request']['url'],
                                {
                                    "message": event.detail['note']["text"]
                                }).then(function () {
                                    location.reload();
                                }).catch(function (res) {
                                    alert("Failed to create note");
                                })

                            break;
                        default:
                            throw "INvalide type";

                    }
                    $(editModal).modal("hide");
                });
            document.getElementById("notesList").addEventListener("removeNote", function (event) {
                console.log("request remove");
                const modal = $('#removeNoteModal');
                modal.find('#noteContent').text(event.detail['note']['text']);
                modal.data['note'] = event.detail['note'];
                modal.data['file'] = event.detail['file'];
                modal.data['request'] = event.detail['request'];
                modal.modal('show');
            });
            document.getElementById("notesList").addEventListener("editNote", function (event) {
                const modal = $('#editNoteModal');

                modal.data['note'] = event.detail['note'];
                modal.data['file'] = event.detail['file'];
                modal.data['request'] = Notes.requestData("edit", event.detail['request']['url']);
                modal.find('#noteEditSaveChangeBtn').text("Apply changes");
                modal.find('#noteContentTextarea').text(event.detail['note']['text']);
                modal.modal('show');
            })
        </script>
        {# ============================= MODALS ============================= #}
        {{ dialog.confirmRemoveFileNote("removeNoteModal") }}
        {{ dialog.editFileNote("editNoteModal") }}


        <div class="card-footer bg-transparent">
             <button id="newNoteBtn" class="btn btn-primary float-right">Add</button>
            <script type="module">
                document.getElementById('newNoteBtn').addEventListener('click', function (event) {
                    const modal = $('#editNoteModal');
                    modal.find('#noteContentTextarea').val("");
                    modal.data['file'] = Notes.fileData({{ file['id'] }});

                    modal.data['request'] = Notes.requestData(
                        "create",
                        "{{ url_for('file_notes', file_id=file['id'] ) }}"
                    );

                    modal.data['note'] = Notes.noteData(null, null);
                    modal.find('#noteEditSaveChangeBtn').text("Create");
                    modal.modal('show');
                });

            </script>
        </div>
    {% endcall %}

{% endblock %}